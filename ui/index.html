<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rift Engine</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0a1a; color: #e0e0e0; padding: 20px; }
        h1 { color: #4fc3f7; margin-bottom: 20px; font-size: 1.8rem; }
        h2 { color: #81d4fa; margin: 20px 0 10px; font-size: 1.2rem; }
        .container { max-width: 1000px; margin: 0 auto; }
        .draft-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .team-box { background: #1a1a2e; border-radius: 12px; padding: 16px; }
        .team-box.blue { border-left: 4px solid #2196f3; }
        .team-box.red { border-left: 4px solid #f44336; }
        .team-box h3 { margin-bottom: 12px; }
        .pick-row { display: grid; grid-template-columns: 1fr 100px; gap: 8px; margin-bottom: 6px; }
        input, select { background: #16213e; border: 1px solid #333; color: #fff; padding: 8px 12px; border-radius: 6px; font-size: 14px; }
        button { background: #4fc3f7; color: #0a0a1a; border: none; padding: 12px 32px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin: 10px 0; }
        button:hover { background: #81d4fa; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        .results { background: #1a1a2e; border-radius: 12px; padding: 20px; margin-top: 20px; display: none; }
        .result-header { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center; margin-bottom: 20px; }
        .stat-card { background: #16213e; border-radius: 8px; padding: 16px; }
        .stat-card .value { font-size: 2rem; font-weight: bold; color: #4fc3f7; }
        .stat-card .label { font-size: 0.85rem; color: #888; margin-top: 4px; }
        .timeline-box { background: #16213e; border-radius: 8px; padding: 12px; max-height: 400px; overflow-y: auto; }
        .event { padding: 6px 0; border-bottom: 1px solid #222; font-size: 0.9rem; }
        .event .time { color: #4fc3f7; font-weight: bold; min-width: 50px; display: inline-block; }
        .deep-dive-controls { margin-bottom: 10px; }
        .deep-dive-controls select { width: 100%; }
        .event-meta { color: #9fb7cf; font-size: 0.82rem; margin-top: 3px; }
        .event-reason { color: #c6d8eb; font-size: 0.85rem; margin-top: 3px; line-height: 1.35; }
        canvas { max-height: 300px; margin: 10px 0; }
        .winner-blue { color: #2196f3; }
        .winner-red { color: #f44336; }
    </style>
</head>
<body>
<div class="container">
    <h1>RIFT ENGINE</h1>
    <p style="color:#888; margin-bottom:20px;">Enter a draft and simulate a match.</p>

    <div class="draft-section">
        <div class="team-box blue">
            <h3 style="color:#2196f3;">Blue Team</h3>
            <input type="text" id="blue-team-name" placeholder="Team name (e.g. T1)" value="T1" style="width:100%; margin-bottom:10px;">
            <div id="blue-picks"></div>
        </div>
        <div class="team-box red">
            <h3 style="color:#f44336;">Red Team</h3>
            <input type="text" id="red-team-name" placeholder="Team name (e.g. Gen.G)" value="Gen.G" style="width:100%; margin-bottom:10px;">
            <div id="red-picks"></div>
        </div>
    </div>

    <button id="simulate-btn" onclick="runSimulation()">SIMULATE MATCH</button>

    <div class="results" id="results">
        <div class="result-header">
            <div class="stat-card">
                <div class="value" id="winner-text">-</div>
                <div class="label">Winner</div>
            </div>
            <div class="stat-card">
                <div class="value" id="duration-text">-</div>
                <div class="label">Game Length</div>
            </div>
            <div class="stat-card">
                <div class="value" id="winprob-text">-</div>
                <div class="label">Blue Win %</div>
            </div>
        </div>

        <h2>Gold Differential</h2>
        <canvas id="gold-chart"></canvas>

        <h2>Event Timeline</h2>
        <div class="timeline-box" id="timeline"></div>

        <h2>Champion Deep Dive</h2>
        <div class="deep-dive-controls">
            <select id="champion-report-select"></select>
        </div>
        <div class="timeline-box" id="champion-report"></div>
    </div>
</div>

<script>
const roles = ['top', 'jungle', 'mid', 'adc', 'support'];
const defaults = {
    blue: ['Renekton', 'LeeSin', 'Ahri', 'Jinx', 'Thresh'],
    red: ['Gnar', 'Viego', 'Syndra', 'Kaisa', 'Nautilus']
};

// Build pick inputs
['blue', 'red'].forEach(side => {
    const container = document.getElementById(`${side}-picks`);
    roles.forEach((role, i) => {
        container.innerHTML += `
            <div class="pick-row">
                <input type="text" id="${side}-${role}" placeholder="${role.toUpperCase()} champion" value="${defaults[side][i]}">
                <select disabled><option>${role.toUpperCase()}</option></select>
            </div>`;
    });
});

let goldChart = null;

function escapeHtml(value) {
    return String(value)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}

async function runSimulation() {
    const btn = document.getElementById('simulate-btn');
    btn.disabled = true;
    btn.textContent = 'SIMULATING...';

    const body = {
        blue_team_id: document.getElementById('blue-team-name').value,
        red_team_id: document.getElementById('red-team-name').value,
        blue_draft: roles.map(r => ({
            champion_id: document.getElementById(`blue-${r}`).value,
            role: r
        })),
        red_draft: roles.map(r => ({
            champion_id: document.getElementById(`red-${r}`).value,
            role: r
        })),
        seed: Math.floor(Math.random() * 100000)
    };

    try {
        const resp = await fetch('/simulate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        showResults(data);
    } catch (err) {
        alert('Error running simulation: ' + err.message);
    }

    btn.disabled = false;
    btn.textContent = 'SIMULATE MATCH';
}

function showResults(data) {
    document.getElementById('results').style.display = 'block';

    // Header stats
    const winEl = document.getElementById('winner-text');
    winEl.textContent = data.winner.toUpperCase();
    winEl.className = `value winner-${data.winner}`;
    document.getElementById('duration-text').textContent = data.duration_minutes + ' min';
    document.getElementById('winprob-text').textContent = (data.blue_win_probability * 100).toFixed(1) + '%';

    // Gold chart
    const labels = data.gold_curve.map(p => (p.time / 60).toFixed(0));
    const diffs = data.gold_curve.map(p => p.gold_diff);

    if (goldChart) goldChart.destroy();
    goldChart = new Chart(document.getElementById('gold-chart'), {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'Gold Diff (Blue advantage)',
                data: diffs,
                borderColor: diffs.map(d => d >= 0 ? '#2196f3' : '#f44336'),
                segment: { borderColor: ctx => (ctx.p1.parsed.y >= 0 ? '#2196f3' : '#f44336') },
                fill: false,
                tension: 0.3,
                pointRadius: 0,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { title: { display: true, text: 'Minutes', color: '#888' }, ticks: { color: '#888' }, grid: { color: '#222' } },
                y: { title: { display: true, text: 'Gold Diff', color: '#888' }, ticks: { color: '#888' }, grid: { color: '#222' } }
            }
        }
    });

    // Timeline
    const tl = document.getElementById('timeline');
    tl.innerHTML = data.timeline
        .filter(e => e.event_type !== 'STATE_SNAPSHOT')
        .map(e => `<div class="event"><span class="time">${(e.time/60).toFixed(1)}m</span> ${e.description}</div>`)
        .join('');

    renderChampionReports(data);
}

function renderChampionReports(data) {
    const reports = data.champion_reports || {};
    const select = document.getElementById('champion-report-select');
    const keys = Object.keys(reports);

    if (keys.length === 0) {
        select.innerHTML = '<option>No report data</option>';
        document.getElementById('champion-report').innerHTML = '<div class="event">No champion report data available.</div>';
        return;
    }

    select.innerHTML = keys.map((k, i) => `<option value="${i}">${escapeHtml(k)}</option>`).join('');
    select.onchange = () => {
        const idx = Number(select.value);
        const key = keys[idx] ?? keys[0];
        renderSingleChampionReport(reports, key);
    };
    select.value = '0';
    renderSingleChampionReport(reports, keys[0]);
}

function renderSingleChampionReport(reports, championKey) {
    const rows = reports[championKey] || [];
    const box = document.getElementById('champion-report');

    if (rows.length === 0) {
        box.innerHTML = '<div class="event">No minute-by-minute data for this champion.</div>';
        return;
    }

    box.innerHTML = rows.map(r => {
        const minute = `${Number(r.minute).toFixed(0)}m`;
        const action = escapeHtml(r.action || 'No action');
        const reasoning = escapeHtml(r.reasoning || '');
        const stats = `L${r.level} | KDA ${r.kda} | ${Math.round(r.gold)}g | CS ${r.cs} | Skills ${r.skill_order}`;
        return `
            <div class="event">
                <span class="time">${minute}</span> ${action}
                <div class="event-meta">${escapeHtml(stats)}</div>
                <div class="event-reason">${reasoning}</div>
            </div>`;
    }).join('');
}
</script>
</body>
</html>
